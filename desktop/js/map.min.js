$.getScript("js/jquery.capitalize.min.js"),window.app={};var app=window.app;app.Drag=function(){ol.interaction.Pointer.call(this,{handleDownEvent:app.Drag.prototype.handleDownEvent,handleDragEvent:app.Drag.prototype.handleDragEvent,handleMoveEvent:app.Drag.prototype.handleMoveEvent,handleUpEvent:app.Drag.prototype.handleUpEvent}),this.coordinate_=null,cursor_="pointer",this.feature_=null,this.previousCursor_=void 0},ol.inherits(app.Drag,ol.interaction.Pointer),app.Drag.prototype.handleDownEvent=function(e){var t=e.map,o=t.forEachFeatureAtPixel(e.pixel,function(e){return e});return o&&(this.coordinate_=e.coordinate,this.feature_=o),!!o},app.Drag.prototype.handleDragEvent=function(e){var t=e.map,o=(t.forEachFeatureAtPixel(e.pixel,function(e){return e}),e.coordinate[0]-this.coordinate_[0]),r=e.coordinate[1]-this.coordinate_[1],i=this.feature_.getGeometry();i.translate(o,r),this.coordinate_[0]=e.coordinate[0],this.coordinate_[1]=e.coordinate[1],$("#position_lon").val(e.coordinate[0]),$("#position_lat").val(e.coordinate[1])},app.Drag.prototype.handleMoveEvent=function(e){if(this.cursor_){var t=e.map,o=t.forEachFeatureAtPixel(e.pixel,function(e){return e}),r=e.map.getTargetElement();o?(flash(e.feature),r.style.cursor!=this.cursor_&&(this.previousCursor_=r.style.cursor,r.style.cursor=this.cursor_)):void 0!==this.previousCursor_&&(r.style.cursor=this.previousCursor_,this.previousCursor_=void 0)}},app.Drag.prototype.handleUpEvent=function(){return this.coordinate_=null,this.feature_=null,!1};var points,vectorSource,json,list;$.when($.ajax({url:"http://128.199.45.65/positions.jsonp",dataType:"jsonp",async:"true"})).then(function(e){function t(e,t){return Number(Math.round(e+"e"+t)+"e-"+t)}function o(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function r(){var e=$("#map");e.height($(window).height()),x.updateSize()}function i(e){var t=ol.animation.pan({duration:1200,source:F.getCenter()});x.beforeRender(t),F.setCenter(q[e])}function a(){_(z)}points=JSON.stringify(e),points=points.substring(1),points=points.substring(0,points.length-1),vectorSource=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(points)}),list=vectorSource.getFeatures();var n,l=0,s=[];for(l=0;l<list.length;l++)s[l]=list[l].q.votes;var c=Math.max.apply(null,s);for(0===c&&c++,l=0,l=0;l<list.length;l++){var u=vectorSource.getClosestFeatureToCoordinate(list[l].q.geometry.j);n=list[l].q.votes;var d=t(n*(9/c)+7,2),p=t(n*(.3/c)+.5,2),g=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"rgba(216, 30, 115,"+p+")"}),radius:d})});u.setStyle(g),u.setId(u.get("id"))}var v=new ol.layer.Vector({source:vectorSource,style:g}),m=new ol.proj.Projection({code:"EPSG:3067",extent:[-3670733.46,4601971.85,642319.78,9362767],units:"m"});ol.proj.addProjection(m),ol.proj.addCoordinateTransforms("EPSG:4326",m,function(e){return[WGStoCHy(e[1],e[0]),WGStoCHx(e[1],e[0])]},function(e){return[CHtoWGSlng(e[0],e[1]),CHtoWGSlat(e[0],e[1])]}),proj4.defs("EPSG:3067","+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"),ol.proj.get("EPSG:3067").setExtent(f);var f=[-3670733.46,4601971.85,642319.78,9362767],h=new ol.Attribution({html:'<a href="http://www.openstreetmap.org/copyright" style="font-size: 14px;">&copy; OpenStreetMapin tekijät, kartta-aineisto Helsingin kaupunki</a>'}),y=new ol.layer.Tile({source:new ol.source.XYZ({url:"http://geoserver.hel.fi/mapproxy/wmts/osm-sm-hq/etrs_tm35fin_hq/{z}/{x}/{y}.png",tilePixelRatio:2,extent:f,attributions:[h]})}),S=[-2172193.974048958,-12743572.109373316],w=10,F=new ol.View({center:S,zoom:w,maxZoom:14,minZoom:5}),x=new ol.Map({layers:[y,v],target:document.getElementById("map"),view:F}),b=document.getElementById("popup"),I=new ol.Overlay({element:b,positioning:"bottom-center",stopEvent:!1});x.addOverlay(I);var C,E=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"rgba(255,0,0,0)"}),radius:0})}),_=function(e){$("div.social").fadeTo(200,0),$(".descWrap").fadeTo(100,0,function(){$(".descName").text(e.get("name").capitalize()),desc=o(e.get("description")),desc=desc.replace(/(?:\r\n|\r|\n)/g,"<br />"),$(".descP").html(desc.capitalize()),$("#date").text(e.get("date")),localStorage.getItem(e.get("id"))?$("#vote").html('<span id="votes" class="vote"></span><img src="img/up.png" id="voteImg" class="vote" alt="upvote" style="opacity:.4">'):($("#vote").html('<span id="votes" class="vote"></span><a href="#" id="addVote"><img src="img/up.png" id="voteImg" class="vote" alt="upvote"></a>'),$("#addVote").click(function(){vote(e.get("id"),function(t){e.set("votes",t)})})),$("#votes").text(null==e.get("votes")?"0":e.get("votes")),$("#idR").val(e.get("id")),$(".reportName").text(e.get("name")),$("#permalink").attr("data-content",'<a href="http://fillari.info/#id='+e.get("id")+'">http://fillari.info/#id='+e.get("id")+"</a>"),$(".lightbox").attr("data-title",e.get("name")),"none"==$("#descFooter").css("display")&&$("#confirm").hide(),$("#confirm").is(":visible")?$("#confirm").fadeTo(200,0,function(){$("#confirm").hide(),$(".social").fadeTo(300,1),$("#descFooter").fadeTo(300,1),$(".descWrap").fadeTo(300,1)}):($("#descFooter").show(),$(".descWrap").fadeTo(100,1))});var t,r,i,a=e.get("images"),n=0,l="";$("#imgWrap").fadeTo(100,0,function(){if(null!==a){for(t=0;t<a.length;t++)r=a[t],i=a[t].replace("original","thumb"),l+='<a href="'+r+'" data-caption="" class="galleryItem"><img class="descImg" src="'+i+'"></a><br>',t+1===a.length&&($("#imgWrap").html(l),$("img.descImg").bind("load",function(){$("img.descImg").each(function(){n++;var e=$(this).width();30>e?$(this).css("right",120):$(this).css("right",e+35),$("#descFooter").is(":visible")&&a.length==n&&$("#imgWrap").fadeTo(200,1)})}));var s=o(e.get("name"));$(".galleryItem").attr("data-caption",s),baguetteBox.run(".gallery",{})}})},P=function(){$(".descWrap").hide(),$("#descFooter").hide(),$(".descName").text(""),$(".descP").html('<b>Pyöräteiden epäkohdat kartalla.</b><br><br>Klikkaa kohdetta nähdäksesi lisätietoja. Mitä enemmän kohteella on tykkäyksiä, sitä suurempana piste näkyy kartalla.<br>Aiheettomista pisteistä voit raportoida painamalla kuvauksen alareunasta löytyvää huutomerkkiä.<br><br>Pisteitä kartalla: <span id="amount"></span>kpl'),$("#amount").text(list.length),$(".descWrap").fadeTo(200,1),$(".social").fadeTo(200,1)};x.on("click",function(e){var t=x.forEachFeatureAtPixel(e.pixel,function(e){return e});t&&"inline"!=$("#open").css("display")?(t.setStyle(t.getStyle()),t.setId(500),C=t.getId(),$("#confirm").is(":visible")?$("#confirm").fadeTo(200,0,function(){$("#confirm").hide(),_(t)}):_(t)):(delete C,$("#descFooter").is(":visible")?P():$("#confirm").is(":visible")&&$("#confirm").fadeTo(200,0,function(){$("#confirm").hide(),P()}),$("#imgWrap").is(":visible")&&$("#imgWrap").fadeTo(200,0,function(){$("#imgWrap").hide()}),"inline"==$("#open").css("display")&&(null!==vectorSource.getFeatureById(500)&&(vectorSource.getFeatureById(500).setStyle(E),vectorSource.removeFeature(vectorSource.getFeatureById(500))),W=new ol.Feature(new ol.geom.Point(x.getCoordinateFromPixel(e.pixel))),W.setId(500),W.setStyle(new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"rgba(216, 30, 115,0.7)"}),radius:13})})),vectorSource.addFeature(W),C=500,$("#position_lon").val(x.getCoordinateFromPixel(e.pixel)[0]),$("#position_lat").val(x.getCoordinateFromPixel(e.pixel)[1])))});var k,T,j,D=0;x.on("pointermove",function(e){if(e.dragging)return void $(b).popover("destroy");var t=x.getEventPixel(e.originalEvent),o=x.hasFeatureAtPixel(t);if(x.getTarget().style.cursor=o?"pointer":"",o&&$("#add").is(":visible")){if(0==D){k=x.forEachFeatureAtPixel(e.pixel,function(e){return e}),j=k.getStyle().getImage().getFill().a;var r=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:j}),radius:k.getStyle().getImage().getRadius()+5})});T=k.getStyle().getImage().getRadius(),k.setStyle(r)}D++}if(0!==D&&!o){var i=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:j}),radius:T})});k.setStyle(i),D=0}});var W,B=new app.Drag,G=new ol.interaction.Select;x.addInteraction(G),$("body").on("click",function(e){if($(e.target).closest("#add").length)null!==vectorSource.getFeatureById(500)&&(vectorSource.getFeatureById(500).setStyle(E),vectorSource.removeFeature(vectorSource.getFeatureById(C))),vectorSource.clear(),W=new ol.Feature(new ol.geom.Point(x.getView().getCenter())),W.setId(500),W.setStyle(new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"rgba(216, 30, 115,0.7)"}),radius:13})})),vectorSource.addFeature(W),x.addInteraction(B);else if($(e.target).closest("img.add").length){null!==vectorSource.getFeatureById(500)&&(vectorSource.getFeatureById(500).setStyle(E),vectorSource.removeFeature(vectorSource.getFeatureById(500))),vectorSource.clear();var o=(new ol.format.GeoJSON).readFeatures(points);vectorSource.addFeatures(o);var r=vectorSource.getFeatures();for(l=0,l=0;l<r.length;l++){var i=vectorSource.getClosestFeatureToCoordinate(r[l].q.geometry.j);n=r[l].q.votes;var a=t(n*(9/c)+7,2),s=t(n*(.3/c)+.5,2),u=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"rgba(216, 30, 115,"+s+")"}),radius:a})});i.setStyle(u)}x.removeInteraction(B),delete C}}),r();var q=[];if(q.espoo=[-2482136.0282985657,-12678584.128667295],q.vantaa=[-2072272.6215921727,-12470177.822796773],q.helsinki=[-2181672.2951651528,-12761559.658812637],$("a.nav").click(function(){i(this.id)}),""!==window.location.hash){var A=window.location.hash.replace("#id=",""),M=A.split("/"),z=vectorSource.getFeatureById(M[0]);1===M.length&&null!=z&&(F.setCenter(z.q.geometry.j),descLoaded?_(z):setTimeout(function(){a()},500))}});var setAmount=function(){"undefined"!=typeof list?$("#amount").text(list.length):setTimeout(function(){setAmount()},500)};
//# sourceMappingURL=map.min.js.map